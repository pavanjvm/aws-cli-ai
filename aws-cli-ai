#!/usr/bin/env bun
import dotenv from 'dotenv'
import * as fs from 'fs'
import * as path from 'path'

// Load .env from current working directory (where command is run)
const cwd = process.cwd()
const envPath = path.resolve(cwd, '.env')
dotenv.config({ path: envPath })

// Also try loading from home directory as fallback
const homeEnv = path.resolve(process.env.HOME || '', '.env')
if (homeEnv !== envPath) {
  dotenv.config({ path: homeEnv })
}

// Load AWS credentials from ~/.aws/credentials and region from ~/.aws/config if not set
const awsCredsPath = path.resolve(process.env.HOME || '', '.aws', 'credentials')
const awsConfigPath = path.resolve(process.env.HOME || '', '.aws', 'config')

if (!process.env.AWS_ACCESS_KEY_ID || !process.env.AWS_SECRET_ACCESS_KEY) {
  if (fs.existsSync(awsCredsPath)) {
    const credsContent = fs.readFileSync(awsCredsPath, 'utf-8')
    const awsKeyMatch = credsContent.match(/aws_access_key_id\s*=\s*(.+)/)
    const awsSecretMatch = credsContent.match(/aws_secret_access_key\s*=\s*(.+)/)
    
    if (awsKeyMatch) process.env.AWS_ACCESS_KEY_ID = awsKeyMatch[1].trim()
    if (awsSecretMatch) process.env.AWS_SECRET_ACCESS_KEY = awsSecretMatch[1].trim()
  }
}

// Set default region if not set
if (!process.env.AWS_REGION) {
  process.env.AWS_REGION = "us-east-1"
}

import program from './src/cli/index.js';

const deployIndex = process.argv.indexOf('--deploy')

if (deployIndex !== -1) {
  try {
    const { runDeploymentAgent } = await import('./src/ai/agent.js')
    await runDeploymentAgent()
  } catch (err) {
    console.error("Deployment agent failed:", err)
    process.exitCode = 1
  }
} else {
  program.parse(process.argv);
}
